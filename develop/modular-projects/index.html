<!DOCTYPE html>
<html lang="en">


<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>Modular projects</title>
  <meta name="description" content="The third edition of µOS++, a POSIX inspired open source system, written in C++.">

  <meta property="og:title" content="Modular projects">
  <meta property="og:site_name" content="µOS++ IIIe">

  <link rel="alternate" type="application/rss+xml" title="µOS++ IIIe" href="/feed.xml">


  <meta property="article:published_time" content="2017-09-26">





  <meta name="google-site-verification" content="NT_y3tqI_8mrd8gYA_FDWHT2-tkJExOC6KBkSnyZx6c">

  <link href="https://fonts.googleapis.com/css?family=Architects+Daughter" rel="stylesheet" type="text/css">

  <link rel="stylesheet" type="text/css" href="/stylesheets/screen.css?201608151703" media="screen">
  <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.css?201608151703" media="screen">
  <link rel="stylesheet" type="text/css" href="/stylesheets/print.css?201608151703" media="print">

  <link rel="canonical" href="http://micro-os-plus.github.io/develop/modular-projects/">



  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-16767008-14', 'auto');
  ga('send', 'pageview');

</script>



</head>


<body>

<div class="container">

  <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.4";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  <script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

  <div class="site-header">
  <table style="width:100%">
    <tr>
      <td>
        <a href="/">
          <img alt="Icon" class="site-icon" src="/assets/icons/wall-e-icon.png" height="100" width="100">
      </a>
      </td>
      <td>
        <table class="site-title" style="width:100%">
          <tr>
            <td class="site-title">
              <a href="/">µOS++ IIIe</a>
            </td>
            <td class="site-motto" align="right">
              “Perfekt ist nicht gut genug”
            </td>
          </tr>
          <tr>
            <td class="site-description" colspan="2">
              The third edition of µOS++, a POSIX inspired open source system, written in C++.
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</div>


</div>

<div class="container">

  <div class="wrapper">
    <div class="site-body">

      <div class="site-sidebar">


  <div class="custom-sidebar">
    <div class="boxed-group-inner">
      <h4 id="news"><a href="/blog/">News</a></h4>

<ul>
  <li><a href="/blog/2017/08/26/micro-os-plus-v6-3-13-released/">µOS++ IIIe v6.3.13 released</a></li>
  <li><a href="/blog/2017/01/02/micro-os-plus-v6-3-11-released/">µOS++ IIIe v6.3.11 released</a></li>
  <li><a href="/blog/2016/11/27/micro-os-plus-v6-3-10-released/">µOS++ IIIe v6.3.10 released</a></li>
  <li><a href="/blog/2016/10/13/micro-os-plus-v6-3-9-released/">µOS++ IIIe v6.3.9 released</a></li>
</ul>


    </div>
  </div>


  <div class="custom-sidebar">
    <div class="boxed-group-inner">
      
      <h4 id="home"><a href="/">Home</a></h4>

<h4 id="µos-iiie">µOS++ IIIe</h4>

<ul>
  <li><a href="/micro-os-plus/">Overview</a></li>
</ul>

<h4 id="apis">APIs</h4>

<ul>
  <li><a href="/cmsis-plus/">Overview</a></li>
  <li><a href="/cmsis-plus/rtos/">RTOS API</a></li>
</ul>

<h4 id="xpacksxcdl">xPacks/XCDL</h4>

<ul>
  <li><a href="/xpacks/">Overview</a></li>
</ul>

<h4 id="documentation">Documentation</h4>

<ul>
  <li>
<a href="/user-manual/">User’s <strong>manual</strong></a>
    <ul>
      <li><a href="/user-manual/getting-started/">Getting started</a></li>
      <li><a href="/user-manual/basic-concepts/">Basic concepts</a></li>
      <li><a href="/user-manual/features/">Features</a></li>
      <li><a href="/user-manual/threads/">Threads</a></li>
      <li><a href="/user-manual/thread-event-flags/">Thread event flags</a></li>
      <li><a href="/user-manual/semaphores/">Semaphores</a></li>
      <li><a href="/user-manual/event-flags/">Event flags</a></li>
      <li>Mutexes</li>
      <li>Condition variables</li>
      <li>Message queues</li>
      <li>Memory pools</li>
      <li>Software timers</li>
      <li>Clocks</li>
    </ul>
  </li>
  <li><a href="/reference/cmsis-plus/">µOS++ <strong>reference</strong></a></li>
</ul>

<h4 id="developer">Developer</h4>

<ul>
  <li><a href="/develop/">Overview</a></li>
  <li><a href="/reference/cmsis-plus/md_doxygen_pages_change-log.html">Change log</a></li>
  <li><a href="/develop/coding-style/">C++ coding style</a></li>
  <li><a href="/develop/references/">Links &amp; references</a></li>
</ul>

<h4 id="support">Support</h4>

<ul>
  <li><a href="/support/">Overview</a></li>
  <li><a href="/support/known-issues/">Known issues</a></li>
  <li><a href="/support/faq/">FAQ</a></li>
  <li><a href="/support/forum/">Forum</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/issues/">Report µOS++ IIIe issues</a></li>
</ul>

<h4 id="latest-articles">Latest Articles</h4>

<ul>
  <li><a href="/articles/arm-com-2016-06-24/">CMSIS++ RTOS: fully functional reference implementation</a></li>
  <li><a href="/articles/arm-com-2016-03-11/">CMSIS++: a proposal for a future CMSIS, written in C++</a></li>
</ul>

<h4 id="license">License</h4>

<ul>
  <li><a href="https://opensource.org/licenses/MIT">MIT</a></li>
</ul>

<h4 id="about"><a href="/about/">About</a></h4>

    </div>
  </div>

  <div class="site-theme">
    This site uses the <a href="https://github.com/ilg-ul/github-jekyll-theme">GitHub Wiki-like</a> theme by <a href="https://github.com/ilg-ul">Liviu Ionescu</a>.
  </div>

</div>


      <div class="site-content">

        
<h1 class="page-title">Modular projects</h1>
<table id="last-modified">
  <tr>
    <td id="last-modified">Last modified on Sat Sep 30 09:33:22 2017 UTC.</td>
    <td id="improve" align="right"><a id="improve" href="https://github.com/micro-os-plus/micro-os-plus.github.io-source/edit/master/pages/develop/modular-projects.md"><i class="fa fa-pencil"></i>  Improve this page</a></td>
  </tr>
</table>

<div id="toc-container">
<table class="toc" id="toc">
<tbody>
<tr>
<td>
<div id="toctitle">
<h2>Contents</h2>
</div>
<ul>
<li class="toc_level-1 toc_section-1">
<a href="#objectives--benefits"><span class="tocnumber">1</span> <span class="toctext">Objectives &amp; benefits</span></a>
<ul>
<li class="toc_level-2 toc_section-2">
<a href="#challenges"><span class="tocnumber">1.1</span> <span class="toctext">Challenges</span></a>
</li>
<li class="toc_level-2 toc_section-3">
<a href="#solution"><span class="tocnumber">1.2</span> <span class="toctext">Solution</span></a>
</li>
<li class="toc_level-2 toc_section-4">
<a href="#benefits"><span class="tocnumber">1.3</span> <span class="toctext">Benefits</span></a>
</li>
</ul>
</li>
<li class="toc_level-1 toc_section-5">
<a href="#project-structure"><span class="tocnumber">2</span> <span class="toctext">Project structure</span></a>
<ul>
<li class="toc_level-2 toc_section-6">
<a href="#application-vs-packages"><span class="tocnumber">2.1</span> <span class="toctext">Application vs packages</span></a>
</li>
<li class="toc_level-2 toc_section-7">
<a href="#example"><span class="tocnumber">2.2</span> <span class="toctext">Example</span></a>
</li>
<li class="toc_level-2 toc_section-8">
<a href="#dependencies"><span class="tocnumber">2.3</span> <span class="toctext">Dependencies</span></a>
</li>
<li class="toc_level-2 toc_section-9">
<a href="#tools"><span class="tocnumber">2.4</span> <span class="toctext">Tools</span></a>
</li>
</ul>
</li>
<li class="toc_level-1 toc_section-10">
<a href="#embedded-projects-specifics"><span class="tocnumber">3</span> <span class="toctext">Embedded projects specifics</span></a>
<ul>
<li class="toc_level-2 toc_section-11">
<a href="#the-startup-code"><span class="tocnumber">3.1</span> <span class="toctext">The startup code</span></a>
</li>
<li class="toc_level-2 toc_section-12">
<a href="#board-vs-device-vs-architecture"><span class="tocnumber">3.2</span> <span class="toctext">Board vs Device vs Architecture</span></a>
</li>
<li class="toc_level-2 toc_section-13">
<a href="#interrupts"><span class="tocnumber">3.3</span> <span class="toctext">Interrupts</span></a>
</li>
<li class="toc_level-2 toc_section-14">
<a href="#linker-scripts"><span class="tocnumber">3.4</span> <span class="toctext">Linker scripts</span></a>
</li>
<li class="toc_level-2 toc_section-15">
<a href="#the-c-and-c-libraries"><span class="tocnumber">3.5</span> <span class="toctext">The C and C++ libraries</span></a>
</li>
<li class="toc_level-2 toc_section-16">
<a href="#tracing-support"><span class="tocnumber">3.6</span> <span class="toctext">Tracing support</span></a>
</li>
</ul>
</li>
<li class="toc_level-1 toc_section-17">
<a href="#demo"><span class="tocnumber">4</span> <span class="toctext">Demo</span></a>
<ul>
<li class="toc_level-2 toc_section-18">
<a href="#eclipse-project-template"><span class="tocnumber">4.1</span> <span class="toctext">Eclipse project template</span></a>
</li>
<li class="toc_level-2 toc_section-19">
<a href="#command-line-template"><span class="tocnumber">4.2</span> <span class="toctext">Command line template</span></a>
</li>
</ul>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="objectives--benefits">Objectives &amp; benefits</h2>

<h3 id="challenges">Challenges</h3>

<p>One of the major challenges when developing software is reusing various pieces of code among applications.</p>

<p>The trivial approach is to simply copy/paste routines or entire files from one application to another. This is ok as long as the code does not change; once the code changes, manually updating all projects is no longer trivial.</p>

<p>A slightly better solution is to create separate libraries, and include them <em>as is</em> in different projects. Initially this may look ok, but if the libraries have inter-dependencies, and their number grows, knowing which libraries are compatible with each other may no longer be as easy as expected.</p>

<p>The problem is aggravated by the fact that each library has its own life cycle, and new versions may no longer be compatible with existing or newer versions of the other libraries.</p>

<h3 id="solution">Solution</h3>

<p>Instead of a monolithic project, where the build has to process a complicated folder hierarchy, one possible solution is to build the project from separate components, stored in separate packages.</p>

<p>In practical terms, each package should have, in addition to the source files, some metadata, to define its own identity and a list of dependencies from other packages.</p>

<h3 id="benefits">Benefits</h3>

<p>This modular approach with structured metadata greatly increase the code reusability and upgradability, by allowing automated tools to bring into the project the required components, and to automatically manage the dependencies, accepting only combinations of compatible packages.</p>

<p>Such solutions are already available for other languages, with the most successful one being <a href="https://www.npmjs.com">npm</a> (The Node Package Manager), for JavaScript modules.</p>

<p>There were also several attempts to create such solutions for C/C++ embedded applications, but they had limited success (for example CMSIS Packs, which uses huge packages and is more or less specific to Keil MDK, and yotta, originally from ARM mbed, now abandoned, which mandates the use of cmake and python).</p>

<h2 id="project-structure">Project structure</h2>

<h3 id="application-vs-packages">Application vs packages</h3>

<p>In the proposed modular approach, the application code is clearly separated from the external packages; the application folders are under full control of the user, who can edit/add/remove any files, while the packages are under the control of the package manager, and generally are read only, to prevent inadvertent changes.</p>

<h3 id="example">Example</h3>

<p>An example of such a project structure is used in the <strong>SiFive project templates</strong>; most of the files are part of the application; the packages are grouped under the <code class="highlighter-rouge">xpacks</code> folder, and the package metadata is located in <code class="highlighter-rouge">package.json</code>:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span>tree -L 2 hifive1-blinky
hifive1-blinky
├── LICENSE
├── README.md
├── build
├── include
│   ├── led.h
│   └── sysclock.h
├── ldscripts
│   ├── libs.ld
│   ├── mem.ld
│   └── sections.ld
├── oocd.launch
├── package.json
├── src
│   ├── initialize-hardware.cpp
│   ├── interrupts-handlers.cpp
│   ├── led.cpp
│   ├── main.cpp
│   ├── newlib-syscalls.c
│   └── sysclock.cpp
├── xmake.json
└── xpacks
    ├── micro-os-plus-c-libs
    ├── micro-os-plus-cpp-libs
    ├── micro-os-plus-diag-trace
    ├── micro-os-plus-riscv-arch
    ├── micro-os-plus-startup
    ├── sifive-coreplex-devices
    └── sifive-hifive1-board

38 directories, 61 files
<span class="gp">$ </span>
</code></pre>
</div>

<h3 id="dependencies">Dependencies</h3>

<p>Each package keeps a list of dependencies to other packages, and the package manager ensures that all required packages are downloaded and made available to the project before the build starts.</p>

<p>For the above project, the <code class="highlighter-rouge">package.json</code> file includes the following dependencies:</p>

<div class="language-json highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"@micro-os-plus/diag-trace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~1.0.1"</span><span class="w">
        </span><span class="p">,</span><span class="nt">"@sifive/hifive1-board"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~0.0.3"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>In other words, the application requires explicit support only for diagnostics and for the <strong>SiFive HiFive1</strong> board. Inspecting the project’s structure, it is easy to identify seven packages, not two. The explanation is that the <code class="highlighter-rouge">sifive-hifive1-board</code> package pulled <code class="highlighter-rouge">sifive-coreplex-devices</code>, which pulled <code class="highlighter-rouge">micro-os-plus-riscv-arch</code>, which pulled <code class="highlighter-rouge">micro-os-plus-startup</code> and the two libraries.</p>

<h3 id="tools">Tools</h3>

<p>To further automate the build process, packages can refer not only to other source packages, but to tools packages, which include separate applications required during the development cycle, like toolchains, debuggers, builders, etc.</p>

<p>This is a very powerful feature, that ensures, in a portable way, that the project can be built immediately after the install is complete.</p>

<h2 id="embedded-projects-specifics">Embedded projects specifics</h2>

<h3 id="the-startup-code">The startup code</h3>

<p>Traditionally, the startup code is written in assembly, the justification being that, right after reset, the run-time is not yet suitable for higher level languages, like C/C++. For some modern architectures, like Cortex-M, this is not necessary, since the core automatically loads the stack pointer before calling the <code class="highlighter-rouge">Reset_Handler</code>, and the startup code can be written in C/C++ from the very beginning (assuming some extra attention when using global variables and avoid excessive optimizations).</p>

<h4 id="the-assembly-entry-code">The assembly entry code</h4>

<p>The more traditional architectures still require some small assembly code to explicitly set several registers.</p>

<p>For RISC-V, the current architecture specs require to manually load the SP and GP registers. However, after preparing these registers, it is perfectly possible to pass control to a portable C/C++ function, traditionally named <code class="highlighter-rouge">_start()</code>:</p>

<div class="language-as highlighter-rouge">
<pre class="highlight"><code>	<span class="p">.</span><span class="nx">section</span>	<span class="p">.</span><span class="nx">reset_entry</span><span class="p">,</span><span class="s2">"ax"</span><span class="p">,</span><span class="err">@</span><span class="nx">progbits</span>
	<span class="p">.</span><span class="nx">align</span>		<span class="err">2</span> <span class="c1">// number of low order zeros, i.e. align to a multiple of 4</span>
	<span class="p">.</span><span class="nx">globl</span>		<span class="nx">riscv_reset_entry</span>
	<span class="p">.</span><span class="nx">type</span>		<span class="nx">riscv_reset_entry</span><span class="p">,</span> <span class="err">@</span><span class="kd">function</span>
<span class="nx">riscv_reset_entry</span><span class="o">:</span>

<span class="p">.</span><span class="nx">option</span> <span class="nx">push</span>
	<span class="c1">// Ensure the instruction is not optimised, since gp is not yet set.</span>
<span class="p">.</span><span class="nx">option</span> <span class="nx">norelax</span>
	<span class="c1">// __global_pointer$ is a magic symbol, known by the linker.</span>
	<span class="c1">// Unless instructed not to do so, the linker optimises</span>
	<span class="c1">// accesses +/- 2KB around this to gp-relative.</span>
	<span class="nx">la</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">__global_pointer$</span>
<span class="p">.</span><span class="nx">option</span> <span class="nx">pop</span>

	<span class="c1">// The linker script usually defines the stack at the end of RAM.</span>
	<span class="nx">la</span> <span class="nx">sp</span><span class="p">,</span> <span class="nx">__stack</span>

	<span class="c1">// Proceed with the standard C _start() routine.</span>
	<span class="nx">j</span> <span class="nx">_start</span>

</code></pre>
</div>

<h4 id="the-portable-startup-code">The portable startup code</h4>

<p>The traditional functionality is to initialize the data &amp; bss sections, to call the C++ static constructors and then pass control to the application <code class="highlighter-rouge">main()</code>.</p>

<p>For embedded applications, the sequence is basically the same, just that several specific initialization routines are added.</p>

<p>A simplified version of the portable startup code is:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="kt">void</span>
<span class="nf">_start</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">os_startup_initialize_hardware_early</span> <span class="p">();</span>

    <span class="n">os_initialize_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">__data_load_addr__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__data_begin__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__data_end__</span><span class="p">);</span>
    <span class="n">os_initialize_bss</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">__bss_begin__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__bss_end__</span><span class="p">);</span>

    <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">initialize</span> <span class="p">();</span>

    <span class="n">os_startup_initialize_hardware</span> <span class="p">();</span>
    <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">printf</span> <span class="p">(</span><span class="s">"Hardware initialized.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">os_startup_initialize_free_store</span> <span class="p">(...);</span>

    <span class="n">os_run_init_array</span> <span class="p">();</span>

    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
    <span class="n">os_startup_initialize_args</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">exit</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
    <span class="cm">/* NOTREACHED */</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The code is more or less self-documented. Perhaps some questions may be raised by the hardware initialization hooks, especially why not doing the initializations inside <code class="highlighter-rouge">main()</code>, and why are needed two hardware initialization routines.</p>

<h4 id="os_startup_initialize_hardware-">
<code class="highlighter-rouge">os_startup_initialize_hardware ()</code>
</h4>

<p>For very simple C applications, it is true that the initialization code can be called from <code class="highlighter-rouge">main()</code>.</p>

<p>But for more complex applications, like most C++ applications, it is common to execute code before entering <code class="highlighter-rouge">main()</code> (like calling constructors for static objects).</p>

<p>This implies that the hardware should be initialized <em>before</em> entering <code class="highlighter-rouge">main()</code>, thus the <code class="highlighter-rouge">os_startup_initialize_hardware ()</code> hook, that must be defined by the application, and is called after the data &amp; bss are initialized and before the static constructors.</p>

<h4 id="os_startup_initialize_hardware_early-">
<code class="highlighter-rouge">os_startup_initialize_hardware_early ()</code>
</h4>

<p>This approach is usually enough, but for some cases running the first initializations after the data &amp; bss might be too late. What if the board uses external RAM? If so, it obviously must be configured <em>before</em> initializing the data &amp; bss sections. Also, if the core starts at a very slow speed, it might be useful to raise the speed as early as possible, to ensure a fast startup. Another interesting case is when the device starts with a watchdog enabled; if the watchdog is not properly tailored to the application, it might trigger a reset before the application reaches the main code.</p>

<h4 id="the-os-prefix-or-namespace">The <code class="highlighter-rouge">os</code> prefix or namespace</h4>

<p>µOS++ is not exactly the traditional RTOS, it is more a run-time environment and a collection of APIs for embedded systems. It does include its own scheduler (written in C++), but it does not mandate its use, it can also run on top of other RTOS (like FreeRTOS).</p>

<p>As such, the <code class="highlighter-rouge">os</code> prefix or namespace does not imply the presence of a scheduler, it is mainly used to differentiate functions that <strong>are not</strong> part of the application.</p>

<h4 id="code">Code</h4>

<p>The entire startup library consists of only two files (one header and one source file), and is available as a separate GitHub project <a href="https://github.com/micro-os-plus/startup.git">micro-os-plus/startup</a>.</p>

<h3 id="board-vs-device-vs-architecture">Board vs Device vs Architecture</h3>

<p>Traditionally, boards come with a BSP (Board Support Package), that provides all board specific definitions and drivers.</p>

<p>However, for reusability reasons, in the µOS++ implementation, the BSP is not monolithic, but modular, with three explicit layers:</p>

<ul>
  <li>board (like <strong>HiFive1</strong>)</li>
  <li>device (like <strong>FE310-G000</strong>)</li>
  <li>architecture (like <strong>RISC-V</strong>)</li>
</ul>

<p>In other words, multiple boards can share the definitions of a single device, and multiple devices can share the definitions specific to a common architecture.</p>

<h4 id="use-of-c">Use of C++</h4>

<p>The following examples include C++ code; actually most of µOS++ is written in C++, but this is only an implementation detail, the application can be entirely written in C, as equivalent C APIs are available at all levels.</p>

<p>Although some voices advocate against using C++ in system code, these opinions are usually based more on believes, than on facts. C++ <strong>can</strong> be successfully used in embedded systems, and modern features, like constexpr, inline templates, can generate even smaller code.</p>

<h4 id="board">Board</h4>

<p>The board definitions can be included in the application with a single <code class="highlighter-rouge">#include</code> line:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include &lt;micro-os-plus/board.h&gt;
</span></code></pre>
</div>

<p>There are currently not many mandatory definitions at board level, except a function that returns the frequency of the RTC oscillator.</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">riscv</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">board</span>
  <span class="p">{</span>
    <span class="kt">uint32_t</span>
    <span class="n">rtc_frequency_hz</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="p">}</span> <span class="cm">/* namespace board */</span>
<span class="p">}</span> <span class="cm">/* namespace riscv */</span>
</code></pre>
</div>

<p>The board package also includes some metadata, used to automatically configure projects using the board, for example:</p>

<div class="language-json highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nt">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
	</span><span class="nt">"boards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nt">"hifive1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nt">"vendor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sifive"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SiFive"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"fullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SiFive, Inc."</span><span class="p">,</span><span class="w">
				</span><span class="nt">"contact"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info@sifive.com"</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nt">"revision"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A01"</span><span class="p">,</span><span class="w">
			</span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.sifive.com/products/hifive1/"</span><span class="p">,</span><span class="w">
			</span><span class="nt">"orderForm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.crowdsupply.com/sifive/hifive1/"</span><span class="p">,</span><span class="w">
			</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HiFive1"</span><span class="p">,</span><span class="w">
			</span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The HiFive1 is an Arduino-Compatible development kit featuring the Freedom E310, the industry’s first commercially available RISC-V SoC."</span><span class="p">,</span><span class="w">
			</span><span class="nt">"installedDevice"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nt">"vendor"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sifive"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fe310-g000"</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nt">"compatibleDevices"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
			</span><span class="nt">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nt">"flash"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"128 Mb"</span><span class="p">,</span><span class="w">
					</span><span class="nt">"interface"</span><span class="p">:</span><span class="w"> </span><span class="s2">"spi0"</span><span class="p">,</span><span class="w">
					</span><span class="nt">"memoryRegion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rom"</span><span class="w">
				</span><span class="p">},</span><span class="w">
				</span><span class="nt">"hfxtal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16 MHz"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"lfxtal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32768 Hz"</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nt">"debug"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nt">"interface"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ftdi"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"connector"</span><span class="p">:</span><span class="w"> </span><span class="s2">"micro-usb"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"openocd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-f &amp;quot;board/sifive-freedom-e300-hifive1.cfg&amp;quot;"</span><span class="p">,</span><span class="w">
				</span><span class="nt">"jlink"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				    </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fe310-g000"</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nt">"compile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="s2">"&lt;micro-os-plus/board.h&gt;"</span><span class="w">
				</span><span class="p">],</span><span class="w">
				</span><span class="nt">"macros"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
					</span><span class="s2">"SIFIVE_HIFIVE1_BOARD"</span><span class="w">
				</span><span class="p">]</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="device">Device</h4>

<p>The device definitions can be included in the application with a single <code class="highlighter-rouge">#include</code> line:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include &lt;micro-os-plus/device.h&gt;
</span></code></pre>
</div>

<p>For RISC-V, the device definitions include functions to access the memory mapped system registers, for example:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">riscv</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">device</span>
  <span class="p">{</span>
    <span class="kt">uint64_t</span>
    <span class="n">mtime</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">mtime</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">value</span><span class="p">);</span>

    <span class="kt">uint64_t</span>
    <span class="n">mtimecmp</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">mtimecmp</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">value</span><span class="p">);</span>

    <span class="c1">// ...
</span>  <span class="p">}</span> <span class="cm">/* namespace device */</span>
<span class="p">}</span> <span class="cm">/* namespace riscv */</span>
</code></pre>
</div>

<p>There are also functions to access the PLIC registers:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">riscv</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">plic</span>
  <span class="p">{</span>
    <span class="kt">void</span>
    <span class="n">initialize</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">clear_priorities</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="n">priority_t</span>
    <span class="n">threshold</span> <span class="p">(</span><span class="n">priority_t</span> <span class="n">priority</span><span class="p">);</span>

    <span class="n">priority_t</span>
    <span class="n">threshold</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">enable_interrupt</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">disable_interrupt</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">);</span>

    <span class="kt">bool</span>
    <span class="n">is_interrupt_enabled</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">priority</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">,</span> <span class="n">priority_t</span> <span class="n">priority</span><span class="p">);</span>

    <span class="n">priority_t</span>
    <span class="n">priority</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">);</span>

    <span class="n">source_t</span>
    <span class="n">claim_interrupt</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">complete_interrupt</span> <span class="p">(</span><span class="n">source_t</span> <span class="n">global_interrupt_id</span><span class="p">);</span>

  <span class="p">}</span> <span class="cm">/* namespace plic */</span>
<span class="p">}</span> <span class="cm">/* namespace riscv */</span>
</code></pre>
</div>

<p>There are also declarations for the local and global interrupt handlers, for example:</p>

<div class="language-c highlighter-rouge">
<pre class="highlight"><code>  <span class="c1">// ...
</span>
  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_wdogcmp</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_rtccmp</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_uart0</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_uart1</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_qspi0</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_qspi1</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_qspi2</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_interrupt_global_handle_gpio0</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="c1">// ...
</span></code></pre>
</div>

<p>The device packages also include some metadata, to be consumed by automated tools, for example:</p>

<div class="language-json highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"devices"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"families"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"fe300"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"vendor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sifive"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"fullName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SiFive, Inc."</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"contact"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info@sifive.com"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Freedom E300"</span><span class="p">,</span><span class="w">
                </span><span class="nt">"devices"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"fe310-g000"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Freedom E310-G000"</span><span class="p">,</span><span class="w">
                        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The FE310-G000 is the first Freedom E300 SoC, and is the industrys first commercially available RISC-V SoC. The FE310-G000 is built around the E31 Coreplex instantiated in the Freedom E300 platform."</span><span class="p">,</span><span class="w">
                        </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.sifive.com/products/freedom-e310/"</span><span class="p">,</span><span class="w">
                        </span><span class="nt">"compile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"&lt;micro-os-plus/device.h&gt;"</span><span class="w">
                            </span><span class="p">],</span><span class="w">
                            </span><span class="nt">"macros"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"SIFIVE_FREEDOM_E310"</span><span class="w">
                            </span><span class="p">],</span><span class="w">
                            </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"-march=rv32imac"</span><span class="p">,</span><span class="w">
                                </span><span class="s2">"-mabi=ilp32"</span><span class="p">,</span><span class="w">
                                </span><span class="s2">"-mcmodel=medany"</span><span class="p">,</span><span class="w">
                                </span><span class="s2">"-msmall-data-limit=8"</span><span class="w">
                            </span><span class="p">]</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RV32IMAC"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"width"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32 bits"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"hfosc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13800 kHz"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"lfosc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32768 Hz"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"maxClock"</span><span class="p">:</span><span class="w"> </span><span class="s2">"320 MHz"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"package"</span><span class="p">:</span><span class="w"> </span><span class="s2">"qfn"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"leads"</span><span class="p">:</span><span class="w"> </span><span class="s2">"48"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"vcc"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"1.8 V"</span><span class="p">,</span><span class="w"> </span><span class="s2">"3.3 V"</span><span class="w"> </span><span class="p">]</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"memoryRegions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"ram"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="nt">"onChip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x80000000"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16 KiB"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"access"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rwx"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"On-Chip Volatile Memory - Data Tightly Integrated Memory (DTIM)"</span><span class="w">
                            </span><span class="p">},</span><span class="w">
                            </span><span class="nt">"rom"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="nt">"onChip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x20000000"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"maxSize"</span><span class="p">:</span><span class="w"> </span><span class="s2">"512 MiB"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"access"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rx"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Off-Chip Non-Volatile Memory - QSPI 0 eXecute-In-Place (XIP)"</span><span class="w">
                            </span><span class="p">}</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"debug"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"jtag"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="nt">"tapindex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"idcode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x10e31913"</span><span class="p">,</span><span class="w">
                                </span><span class="nt">"irlen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="w">
                            </span><span class="p">}</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"xsvd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xsvd/fe310-g000-xsvd.json"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>To support debuggers and emulators, a special file with the structured definitions of the peripheral registered is used:</p>

<div class="language-json highlighter-rouge">
<pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"devices"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"fe310-g000"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Freedom E310-G000"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The FE310-G000 is the first Freedom E300 SoC, and is the industrys first commercially available RISC-V SoC. The FE310-G000 is built around the E31 Coreplex instantiated in the Freedom E300 platform."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"busWidth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"resetValue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x00000000"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"resetMask"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0xFFFFFFFF"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"access"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rw"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"peripherals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"clint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Coreplex-Local Interruptor (CLINT)"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"baseAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x02000000"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x10000"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"registers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nt">"msip0"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MSIP for hart 0"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"addressOffset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x0000"</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"mtimecmp0"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Timer compare register for hart 0"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"addressOffset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0x4000"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"64"</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nt">"mtime"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Timer register"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"addressOffset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0xBFF8"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"access"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ro"</span><span class="p">,</span><span class="w">
                            </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"64"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h4 id="architecture">Architecture</h4>

<p>The architecture definitions can be included in the application with a single <code class="highlighter-rouge">#include</code> line:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include &lt;micro-os-plus/architecture.h&gt;
</span></code></pre>
</div>

<p>For RISC-V, the architecture definitions include functions to access the CSRs, for example:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">riscv</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">csr</span>
  <span class="p">{</span>
    <span class="n">arch</span><span class="o">::</span><span class="n">register_t</span>
    <span class="n">mstatus</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">mstatus</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">value</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">clear_mstatus</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">mask</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">set_mstatus</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">mask</span><span class="p">);</span>

    <span class="n">arch</span><span class="o">::</span><span class="n">register_t</span>
    <span class="n">mtvec</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">mtvec</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">value</span><span class="p">);</span>

    <span class="n">arch</span><span class="o">::</span><span class="n">register_t</span>
    <span class="n">mcause</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="n">arch</span><span class="o">::</span><span class="n">register_t</span>
    <span class="n">mie</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">mie</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">value</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">clear_mie</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">mask</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">set_mie</span> <span class="p">(</span><span class="n">arch</span><span class="o">::</span><span class="n">register_t</span> <span class="n">mask</span><span class="p">);</span>

    <span class="kt">uint64_t</span>
    <span class="n">mcycle</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">uint32_t</span>
    <span class="n">mcycle_low</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">uint32_t</span>
    <span class="n">mcycle_high</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="n">arch</span><span class="o">::</span><span class="n">register_t</span>
    <span class="n">mhartid</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="c1">// ...
</span>  <span class="p">}</span> <span class="cm">/* namespace csr */</span>
<span class="p">}</span> <span class="cm">/* namespace riscv */</span>
</code></pre>
</div>

<p>There are also declarations for the synchronous exceptions and the common local interrupt handlers, for example:</p>

<div class="language-c highlighter-rouge">
<pre class="highlight"><code>  <span class="kt">void</span>
  <span class="n">riscv_exception_handle_misaligned_fetch</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_exception_handle_fault_fetch</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_exception_handle_illegal_instruction</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="kt">void</span>
  <span class="n">riscv_exception_handle_breakpoint</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="c1">// ...
</span></code></pre>
</div>

<h3 id="interrupts">Interrupts</h3>

<p>In modern architectures, the software requirements for interrupt processing are minimal, there is almost nothing to do, apart from providing a list of pointers to interrupt handlers.</p>

<p>Although for RISC-V the architecture specs make interrupt processing significantly more complicated, the current µOS++ implementation tries to provide a similar user experience, by hiding all the implementation details. The application has nothing else to do but define some fixed name functions and enable interrupts.</p>

<p>For example, to handle the machine timer interrupt, the application code looks like this:</p>

<div class="language-c highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include &lt;micro-os-plus/device.h&gt;
</span>
<span class="kt">void</span>
<span class="nf">riscv_interrupt_local_handle_machine_timer</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...
</span><span class="p">}</span>
</code></pre>
</div>

<p>Similar definitions are available for global interrupts, for example to handle the interrupts generated by GPIO pin 4, the application code looks like this:</p>

<div class="language-c highlighter-rouge">
<pre class="highlight"><code><span class="kt">void</span>
<span class="nf">riscv_interrupt_global_handle_gpio4</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...
</span><span class="p">}</span>
</code></pre>
</div>

<p>The prototypes of these functions are provided by the device or architecture packages.</p>

<h3 id="linker-scripts">Linker scripts</h3>

<p>As with most other projects generated by the GNU MCU Eclipse templates, the linker script is split into three parts:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span>tree ldscripts
ldscripts
├── libs.ld
├── mem.ld
└── sections.ld

0 directories, 3 files
<span class="err">$</span>
</code></pre>
</div>

<p>The names should indicate the content: <code class="highlighter-rouge">libs.ld</code> defines the additional libraries, <code class="highlighter-rouge">mem.ld</code> defines the memory regions and <code class="highlighter-rouge">sections.ld</code> defines the  sections and the mapping to the memory regions.</p>

<p>To make the build use them all, add something like this when invoking the linker:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span>&lt;prefix&gt;-g++ ... -L ldscripts -T libs.ld -T mem.ld -T sections.ld ...
</code></pre>
</div>

<h3 id="the-c-and-c-libraries">The C and C++ libraries</h3>

<p>These two packages complement the system libraries and provide missing functions or have lighter implementations, more suitable for embedded applications.</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span>tree c-libs.git 
c-libs.git
├── LICENSE
├── README.md
├── include
│   └── newlib
│       └── c-syscalls.h
├── package-lock.json
├── package.json
└── src
    ├── _sbrk.c
    ├── c-syscalls-empty.c
    └── stdlib
        ├── assert.c
        ├── atexit.cpp
        ├── atexit.h
        ├── exit.c
        └── init-fini.c

4 directories, 12 files

<span class="gp">$ </span>tree cpp-libs.git
cpp-libs.git
├── LICENSE
├── README.md
├── include
├── package-lock.json
├── package.json
└── src
    └── cxx.cpp

2 directories, 5 files
<span class="err">$</span>
</code></pre>
</div>

<h3 id="tracing-support">Tracing support</h3>

<p>Although modern debuggers are quite advanced and can display lots of useful information, there are many cases when the classical <code class="highlighter-rouge">printf()</code>, placed at the right location, can be more efficient in spotting bugs.</p>

<h4 id="the-traditional-approach-redirect-stdoutstderr">The traditional approach, redirect STDOUT/STDERR</h4>

<p>Using <code class="highlighter-rouge">printf()</code> in Unix environments is as easy as it can be since standard IO support is always available, but in embedded environments the full standard IO libraries may be too expensive, in terms of program size and especially in complexity; without system operating support, the traditional solution to make the trace messages go out via a dedicated peripheral (a hardware debug channel, like ARM ITM, or even an USART port), is to rewrite a low level function, like <code class="highlighter-rouge">_write()</code> in newlib; unfortunately, the path from <code class="highlighter-rouge">printf()</code> to the actual <code class="highlighter-rouge">_write()</code> is quite long.</p>

<p>Plus in some applications, like those using semihosting, the standard output and standard error are already used for normal functionality (like outputting test results) and intermixing trace messages may interfere with the normal behaviour.</p>

<h4 id="use-a-separate-trace-channel">Use a separate trace channel</h4>

<p>Since for debug purposes things should be as simple as possible, the preferred solution is to avoid using STDOUT or STDERR at all, and use a completely separated trace channel, that does not depend at all on the usual redirected system functions.</p>

<p>Using these functions is very simple, the prototypes being identical to the standard calls, but placed in a separate namespace (in C++) or a separate prefix (in C):</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include &lt;micro-os-plus/diag/trace.h&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">os</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>    <span class="n">trace</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="s">"Hello %s %d</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="c1">// in C++
</span>    <span class="n">trace_printf</span><span class="p">(</span><span class="s">"Hello %s %d</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="c1">// in C
</span>    <span class="c1">// ...
</span><span class="p">}</span>
</code></pre>
</div>

<p>The complete public C++ API is:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="kt">int</span> <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">printf</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">int</span> <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">putchar</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">puts</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">vprintf</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">va_list</span> <span class="n">args</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="n">os</span><span class="o">::</span><span class="n">trace</span><span class="o">::</span><span class="n">write</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">nbyte</span><span class="p">);</span>
</code></pre>
</div>

<h4 id="the-trace-macro">The TRACE macro</h4>

<p>Support for the trace functions is enabled by adding the <code class="highlighter-rouge">TRACE</code> preprocessor definition when invoking the compiler. Without it, the header defines empty inline functions, so there is no need to explicitly brace the <code class="highlighter-rouge">trace::prinf()</code> calls with <code class="highlighter-rouge">#if defined(TRACE) / #endif</code>, which is quite convenient.</p>

<h4 id="implementation">Implementation</h4>

<p>The implementation is simple, it uses <code class="highlighter-rouge">vsnprintf()</code> to output to a local buffer, then calls <code class="highlighter-rouge">trace::write()</code> (which must be implemented by the application) to transfer the buffer to the desired peripheral.</p>

<p>The custom functions that need to be implemented by the application have a simple and unsurprising API:</p>

<div class="language-c++ highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">os</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">trace</span>
  <span class="p">{</span>
    <span class="kt">void</span>
    <span class="n">initialize</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">ssize_t</span>
    <span class="n">write</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">nbyte</span><span class="p">);</span>

    <span class="kt">void</span>
    <span class="n">flush</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

  <span class="p">}</span> <span class="cm">/* namespace trace */</span>
<span class="p">}</span> <span class="cm">/* namespace os */</span>
</code></pre>
</div>

<h4 id="code-1">Code</h4>

<p>The entire trace library consists of only two files (one header and one source file), and is available as a separate GitHub project <a href="https://github.com/micro-os-plus/diag-trace.git">micro-os-plus/diag-trace</a> that has no other dependencies and can be included in any application.</p>

<h2 id="demo">Demo</h2>

<h3 id="eclipse-project-template">Eclipse project template</h3>

<ul>
  <li>generate project</li>
  <li>build</li>
</ul>

<h3 id="command-line-template">Command line template</h3>

<ul>
  <li>generate project</li>
  <li>build with xmake</li>
</ul>









<ul class="share-buttons">
  <li><div class="fb-share-button" data-href="http://micro-os-plus.github.io/develop/modular-projects/" data-layout="button"></div></li>
  <li><div class="tw-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a></div></li>
</ul>



      </div>

    </div>
  </div>

</div>

<div class="container">

  <div class="site-footer">
  <div class="site-footer-links left">
    <ul>
  <li>© 2017 Liviu Ionescu</li>
  <li>Hosted on GitHub</li>
  <li>
    <p><a href="/feed.xml"><img src="/assets/images/feed-20.png" alt="RSS"></a></p>
  </li>
  <li>
<a href="http://twitter.com/micro_os_plus" class="twitter-follow-button" data-show-count="false">Follow @micro_os_plus</a><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</li>
</ul>


  </div>
  <a href="https://github.com/micro-os-plus/micro-os-plus-iii" aria-label="Homepage">
      <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
  </a>
  <div class="site-footer-links right">
    <ul>
  <li><a href="/">Home</a></li>
  <li><a href="/blog/">News</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/releases">Releases</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/issues">Support</a></li>
  <li><a href="/about/">About</a></li>
</ul>

  </div>
</div>


</div>

</body>
</html>
